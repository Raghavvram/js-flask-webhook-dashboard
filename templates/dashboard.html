<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <style>
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f2e;
            --bg-tertiary: #252d3d;
            --text-primary: #e6e8eb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-primary: #3b82f6;
            --accent-secondary: #1d4ed8;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --border-color: #374151;
            --shadow-dark: rgba(0, 0, 0, 0.25);
            --gradient-primary: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .dashboard {
            min-height: 100vh;
            background: var(--gradient-primary);
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 2rem 2.5rem;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            margin-bottom: 3rem;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-badge {
            background: var(--accent-primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .last-update {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2.5rem 3rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 2.5rem;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .stat-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 10px 40px var(--shadow-dark);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .stat-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-variant-numeric: tabular-nums;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filters {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 2.5rem;
            margin-bottom: 3rem;
        }

        .filters h3 {
            color: var(--text-primary);
            margin-bottom: 2rem;
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }

        .filter-group select,
        .filter-group input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.875rem 1rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-group select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .filter-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
        }

        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 2.5rem;
            transition: all 0.2s ease;
        }

        .chart-container:hover {
            border-color: var(--accent-primary);
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .chart-container h3 {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        #chartdiv {
            width: 100%;
            height: 100%;
            min-height: 400px;
        }

        .visitors-table {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .table-header {
            background: var(--bg-tertiary);
            padding: 2rem 2.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .table-header h3 {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        /* Modern Scrollbar Styling */
        .table-wrapper::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 10px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 10px;
            border: 2px solid var(--bg-secondary);
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background-color: var(--accent-primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1.25rem 1.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        tbody tr {
            transition: background-color 0.2s ease;
        }

        tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .status-badge {
            padding: 0.375rem 0.875rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-success);
        }

        .status-idle {
            background: rgba(245, 158, 11, 0.1);
            color: var(--accent-warning);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: var(--accent-danger);
            padding: 1.5rem 2rem;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
            font-size: 0.875rem;
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .section-spacing {
            margin-bottom: 3rem;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1.5rem;
                text-align: center;
            }

            .chart-container {
                margin-bottom: 0;
            }

            .filter-buttons {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .content {
                padding: 0 1.5rem 2rem;
            }

            .header {
                padding: 1.5rem;
                margin-bottom: 2rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .filter-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .filters {
                padding: 2rem;
            }

            .chart-container {
                padding: 2rem;
            }

            .filter-buttons {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>
                        Analytics Dashboard
                        <span class="header-badge">Live</span>
                    </h1>
                </div>
                <div class="last-update" id="lastUpdate">
                    Last updated: Loading...
                </div>
            </div>
        </div>

        <div class="content">
            <div class="stats-grid section-spacing">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                            üë•
                        </div>
                    </div>
                    <div class="stat-value" id="totalVisitors">-</div>
                    <div class="stat-label">Total Visitors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                            üÜî
                        </div>
                    </div>
                    <div class="stat-value" id="uniqueVisitors">-</div>
                    <div class="stat-label">Unique Visitors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                            üîÑ
                        </div>
                    </div>
                    <div class="stat-value" id="repeatedVisitors">-</div>
                    <div class="stat-label">Returning Visitors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                            ‚è±Ô∏è
                        </div>
                    </div>
                    <div class="stat-value" id="avgTimeOnPage">-</div>
                    <div class="stat-label">Avg. Session (sec)</div>
                </div>
            </div>

            <div class="filters section-spacing">
                <h3>üîç Advanced Filters</h3>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>Country</label>
                        <select id="countryFilter">
                            <option value="">All Countries</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Device Type</label>
                        <select id="deviceFilter">
                            <option value="">All Devices</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Browser</label>
                        <select id="browserFilter">
                            <option value="">All Browsers</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Visitor Type</label>
                        <select id="visitorTypeFilter">
                            <option value="all">All Visitors</option>
                            <option value="unique">Unique Only</option>
                            <option value="repeated">Returning Only</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Start Date</label>
                        <input type="date" id="startDateFilter">
                    </div>
                    <div class="filter-group">
                        <label>End Date</label>
                        <input type="date" id="endDateFilter">
                    </div>
                </div>
                <div class="filter-buttons">
                    <button class="btn btn-secondary" id="resetFiltersBtn">
                        üîÑ Reset Filters
                    </button>
                    <button class="btn btn-primary" id="applyFiltersBtn">
                        üîç Apply Filters
                    </button>
                </div>
            </div>

            <div class="main-grid section-spacing">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>üåç Global Visitor Distribution</h3>
                    </div>
                    <div class="chart-wrapper">
                        <div id="chartdiv"></div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3>üìà Traffic Timeline</h3>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="timeChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>üì± Device Analytics</h3>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="deviceChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3>üåê Browser Distribution</h3>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="browserChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="visitors-table section-spacing">
                <div class="table-header">
                    <h3>üë§ Recent Visitor Activity</h3>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Location</th>
                                <th>Device</th>
                                <th>Browser</th>
                                <th>Page Visited</th>
                                <th>Session Time</th>
                                <th>IP Address</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="visitorsTableBody">
                            <tr>
                                <td colspan="8" class="loading">
                                    <span class="pulse">Loading visitor data...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        let currentData = {};
        let mapRoot = null;

        // Country code to name mapping for amCharts
        const countryCodeMapping = {
            'AD': 'Andorra', 'AE': 'United Arab Emirates', 'AF': 'Afghanistan', 'AG': 'Antigua and Barbuda',
            'AI': 'Anguilla', 'AL': 'Albania', 'AM': 'Armenia', 'AO': 'Angola', 'AQ': 'Antarctica',
            'AR': 'Argentina', 'AS': 'American Samoa', 'AT': 'Austria', 'AU': 'Australia',
            'AW': 'Aruba', 'AX': '√Öland Islands', 'AZ': 'Azerbaijan', 'BA': 'Bosnia and Herzegovina',
            'BB': 'Barbados', 'BD': 'Bangladesh', 'BE': 'Belgium', 'BF': 'Burkina Faso',
            'BG': 'Bulgaria', 'BH': 'Bahrain', 'BI': 'Burundi', 'BJ': 'Benin', 'BL': 'Saint Barth√©lemy',
            'BM': 'Bermuda', 'BN': 'Brunei', 'BO': 'Bolivia', 'BQ': 'Caribbean Netherlands',
            'BR': 'Brazil', 'BS': 'Bahamas', 'BT': 'Bhutan', 'BV': 'Bouvet Island',
            'BW': 'Botswana', 'BY': 'Belarus', 'BZ': 'Belize', 'CA': 'Canada',
            'CC': 'Cocos Islands', 'CD': 'Democratic Republic of the Congo', 'CF': 'Central African Republic',
            'CG': 'Congo', 'CH': 'Switzerland', 'CI': 'Ivory Coast', 'CK': 'Cook Islands',
            'CL': 'Chile', 'CM': 'Cameroon', 'CN': 'China', 'CO': 'Colombia', 'CR': 'Costa Rica',
            'CU': 'Cuba', 'CV': 'Cape Verde', 'CW': 'Cura√ßao', 'CX': 'Christmas Island',
            'CY': 'Cyprus', 'CZ': 'Czech Republic', 'DE': 'Germany', 'DJ': 'Djibouti',
            'DK': 'Denmark', 'DM': 'Dominica', 'DO': 'Dominican Republic', 'DZ': 'Algeria',
            'EC': 'Ecuador', 'EE': 'Estonia', 'EG': 'Egypt', 'EH': 'Western Sahara',
            'ER': 'Eritrea', 'ES': 'Spain', 'ET': 'Ethiopia', 'FI': 'Finland', 'FJ': 'Fiji',
            'FK': 'Falkland Islands', 'FM': 'Micronesia', 'FO': 'Faroe Islands', 'FR': 'France',
            'GA': 'Gabon', 'GB': 'United Kingdom', 'GD': 'Grenada', 'GE': 'Georgia',
            'GF': 'French Guiana', 'GG': 'Guernsey', 'GH': 'Ghana', 'GI': 'Gibraltar',
            'GL': 'Greenland', 'GM': 'Gambia', 'GN': 'Guinea', 'GP': 'Guadeloupe',
            'GQ': 'Equatorial Guinea', 'GR': 'Greece', 'GS': 'South Georgia', 'GT': 'Guatemala',
            'GU': 'Guam', 'GW': 'Guinea-Bissau', 'GY': 'Guyana', 'HK': 'Hong Kong',
            'HM': 'Heard Island', 'HN': 'Honduras', 'HR': 'Croatia', 'HT': 'Haiti',
            'HU': 'Hungary', 'ID': 'Indonesia', 'IE': 'Ireland', 'IL': 'Israel',
            'IM': 'Isle of Man', 'IN': 'India', 'IO': 'British Indian Ocean Territory', 'IQ': 'Iraq',
            'IR': 'Iran', 'IS': 'Iceland', 'IT': 'Italy', 'JE': 'Jersey', 'JM': 'Jamaica',
            'JO': 'Jordan', 'JP': 'Japan', 'KE': 'Kenya', 'KG': 'Kyrgyzstan', 'KH': 'Cambodia',
            'KI': 'Kiribati', 'KM': 'Comoros', 'KN': 'Saint Kitts and Nevis', 'KP': 'North Korea',
            'KR': 'South Korea', 'KW': 'Kuwait', 'KY': 'Cayman Islands', 'KZ': 'Kazakhstan',
            'LA': 'Laos', 'LB': 'Lebanon', 'LC': 'Saint Lucia', 'LI': 'Liechtenstein',
            'LK': 'Sri Lanka', 'LR': 'Liberia', 'LS': 'Lesotho', 'LT': 'Lithuania',
            'LU': 'Luxembourg', 'LV': 'Latvia', 'LY': 'Libya', 'MA': 'Morocco',
            'MC': 'Monaco', 'MD': 'Moldova', 'ME': 'Montenegro', 'MF': 'Saint Martin',
            'MG': 'Madagascar', 'MH': 'Marshall Islands', 'MK': 'Macedonia', 'ML': 'Mali',
            'MM': 'Myanmar', 'MN': 'Mongolia', 'MO': 'Macao', 'MP': 'Northern Mariana Islands',
            'MQ': 'Martinique', 'MR': 'Mauritania', 'MS': 'Montserrat', 'MT': 'Malta',
            'MU': 'Mauritius', 'MV': 'Maldives', 'MW': 'Malawi', 'MX': 'Mexico',
            'MY': 'Malaysia', 'MZ': 'Mozambique', 'NA': 'Namibia', 'NC': 'New Caledonia',
            'NE': 'Niger', 'NF': 'Norfolk Island', 'NG': 'Nigeria', 'NI': 'Nicaragua',
            'NL': 'Netherlands', 'NO': 'Norway', 'NP': 'Nepal', 'NR': 'Nauru',
            'NU': 'Niue', 'NZ': 'New Zealand', 'OM': 'Oman', 'PA': 'Panama',
            'PE': 'Peru', 'PF': 'French Polynesia', 'PG': 'Papua New Guinea', 'PH': 'Philippines',
            'PK': 'Pakistan', 'PL': 'Poland', 'PM': 'Saint Pierre and Miquelon', 'PN': 'Pitcairn',
            'PR': 'Puerto Rico', 'PS': 'Palestine', 'PT': 'Portugal', 'PW': 'Palau',
            'PY': 'Paraguay', 'QA': 'Qatar', 'RE': 'Reunion', 'RO': 'Romania',
            'RS': 'Serbia', 'RU': 'Russia', 'RW': 'Rwanda', 'SA': 'Saudi Arabia',
            'SB': 'Solomon Islands', 'SC': 'Seychelles', 'SD': 'Sudan', 'SE': 'Sweden',
            'SG': 'Singapore', 'SH': 'Saint Helena', 'SI': 'Slovenia', 'SJ': 'Svalbard and Jan Mayen',
            'SK': 'Slovakia', 'SL': 'Sierra Leone', 'SM': 'San Marino', 'SN': 'Senegal',
            'SO': 'Somalia', 'SR': 'Suriname', 'SS': 'South Sudan', 'ST': 'S√£o Tom√© and Pr√≠ncipe',
            'SV': 'El Salvador', 'SX': 'Sint Maarten', 'SY': 'Syria', 'SZ': 'Swaziland',
            'TC': 'Turks and Caicos Islands', 'TD': 'Chad', 'TF': 'French Southern Territories',
            'TG': 'Togo', 'TH': 'Thailand', 'TJ': 'Tajikistan', 'TK': 'Tokau',
            'TL': 'East Timor', 'TM': 'Turkmenistan', 'TN': 'Tunisia', 'TO': 'Tonga',
            'TR': 'Turkey', 'TT': 'Trinidad and Tobago', 'TV': 'Tuvalu', 'TW': 'Taiwan',
            'TZ': 'Tanzania', 'UA': 'Ukraine', 'UG': 'Uganda', 'UM': 'United States Minor Outlying Islands',
            'US': 'United States', 'UY': 'Uruguay', 'UZ': 'Uzbekistan', 'VA': 'Vatican',
            'VC': 'Saint Vincent and the Grenadines', 'VE': 'Venezuela', 'VG': 'British Virgin Islands',
            'VI': 'U.S. Virgin Islands', 'VN': 'Vietnam', 'VU': 'Vanuatu', 'WF': 'Wallis and Futuna',
            'WS': 'Samoa', 'YE': 'Yemen', 'YT': 'Mayotte', 'ZA': 'South Africa',
            'ZM': 'Zambia', 'ZW': 'Zimbabwe'
        };

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof am5 === 'undefined') {
                console.error('amCharts not loaded');
                return;
            }
            loadData();
            setupFilterButtons();
            setInterval(loadData, 30000);
        });

        function setupFilterButtons() {
            document.getElementById('applyFiltersBtn').addEventListener('click', loadData);
            document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
        }

        function resetFilters() {
            document.getElementById('countryFilter').value = '';
            document.getElementById('deviceFilter').value = '';
            document.getElementById('browserFilter').value = '';
            document.getElementById('visitorTypeFilter').value = 'all';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            loadData();
        }

        function renderMap(countryData = []) {
            try {
                if (mapRoot) {
                    mapRoot.dispose();
                }
                mapRoot = am5.Root.new("chartdiv");
                mapRoot.setThemes([am5themes_Animated.new(mapRoot)]);

                let chart = mapRoot.container.children.push(am5map.MapChart.new(mapRoot, {
                    panX: "rotateX",
                    panY: "translateY",
                    projection: am5map.geoMercator(),
                    homeZoomLevel: 1.2,
                    homeGeoPoint: { longitude: 0, latitude: 0 }
                }));

                let polygonSeries = chart.series.push(am5map.MapPolygonSeries.new(mapRoot, {
                    geoJSON: am5geodata_worldLow,
                    exclude: ["AQ"],
                    valueField: "value",
                    calculateAggregates: true
                }));

                polygonSeries.mapPolygons.template.setAll({
                    tooltipText: "{name}: {value} visitors",
                    interactive: true,
                    fill: am5.color(getComputedStyle(document.documentElement).getPropertyValue('--bg-tertiary')),
                    stroke: am5.color(getComputedStyle(document.documentElement).getPropertyValue('--border-color')),
                    strokeWidth: 0.5
                });

                polygonSeries.mapPolygons.template.states.create("hover", {
                    fill: am5.color(getComputedStyle(document.documentElement).getPropertyValue('--accent-primary'))
                });

                polygonSeries.set("heatRules", [{
                    target: polygonSeries.mapPolygons.template,
                    key: "fill",
                    min: am5.color(getComputedStyle(document.documentElement).getPropertyValue('--accent-primary')),
                    max: am5.color(getComputedStyle(document.documentElement).getPropertyValue('--accent-success')),
                    dataField: "value",
                    logarithmic: false
                }]);

                const processedData = countryData.map(item => ({
                    id: item.id,
                    name: countryCodeMapping[item.id] || item.id,
                    value: item.value || 0
                })).filter(item => item.value > 0 && item.id);

                polygonSeries.data.setAll(processedData);
                chart.set("zoomControl", am5map.ZoomControl.new(mapRoot, {}));

            } catch (error) {
                console.error('Error rendering map:', error);
                document.getElementById('chartdiv').innerHTML = '<div class="error">Failed to load world map.</div>';
            }
        }

        async function loadData() {
            try {
                const params = new URLSearchParams({
                    'country_filter': document.getElementById('countryFilter').value,
                    'device_filter': document.getElementById('deviceFilter').value,
                    'browser_filter': document.getElementById('browserFilter').value,
                    'visitor_type_filter': document.getElementById('visitorTypeFilter').value,
                    'start_date_filter': document.getElementById('startDateFilter').value,
                    'end_date_filter': document.getElementById('endDateFilter').value
                });

                const response = await fetch(`/api/analytics?${params.toString()}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                updateLastUpdateTime();
                updateStats(data.stats || {});
                updateCharts(data.charts || {});
                updateVisitorsTable(data.visitor_list || []);
                updateFilters(data.meta || {});

            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load analytics data: ' + error.message);
            }
        }

        function updateStats(stats) {
            document.getElementById('totalVisitors').textContent = stats.total_visitors || 0;
            document.getElementById('uniqueVisitors').textContent = stats.unique_visitors || 0;
            document.getElementById('repeatedVisitors').textContent = stats.repeated_visitors || 0;
            document.getElementById('avgTimeOnPage').textContent = stats.avg_time_on_page || 0;
        }

        function updateCharts(chartsData) {
            renderMap(chartsData.by_country || []);
            updateChart('deviceChart', 'device', 'doughnut', chartsData.by_device, item => item.device_type, item => item.count);
            updateChart('browserChart', 'browser', 'bar', chartsData.by_browser, item => item.browser, item => item.count, { legend: { display: false } });
            updateTimeChart(chartsData.by_date || []);
        }

        function updateChart(canvasId, chartKey, type, data, labelSelector, valueSelector, extraOptions = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (charts[chartKey]) charts[chartKey].destroy();

            const chartColors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#e6e8eb', padding: 20, usePointStyle: true }
                    }
                },
                scales: type === 'bar' ? {
                    y: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: '#374151' } },
                    x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }
                } : {}
            };

            charts[chartKey] = new Chart(ctx, {
                type: type,
                data: {
                    labels: data.map(labelSelector),
                    datasets: [{
                        data: data.map(valueSelector),
                        backgroundColor: type === 'bar' ? chartColors[0] : chartColors,
                        borderColor: '#1a1f2e',
                        borderWidth: type === 'doughnut' ? 2 : 1,
                        borderRadius: type === 'bar' ? 4 : 0
                    }]
                },
                options: { ...defaultOptions, ...extraOptions }
            });
        }

        function updateTimeChart(data) {
            const ctx = document.getElementById('timeChart').getContext('2d');
            if (charts.time) charts.time.destroy();

            const sortedData = data.sort((a, b) => new Date(a.date) - new Date(b.date));

            charts.time = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedData.map(item => new Date(item.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Visitors',
                        data: sortedData.map(item => item.count),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateVisitorsTable(visitors) {
            const tbody = document.getElementById('visitorsTableBody');
            if (!visitors || visitors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#6b7280;">No visitor data available</td></tr>';
                return;
            }

            tbody.innerHTML = visitors.map(visitor => {
                const createdAt = new Date(visitor.created_at);
                const timeSpent = visitor.time_spent_seconds ? `${visitor.time_spent_seconds}s` : '-';
                const pageUrl = visitor.page_visited?.length > 40 ? `${visitor.page_visited.substring(0, 40)}...` : (visitor.page_visited || '-');
                const location = [visitor.city, visitor.country].filter(Boolean).join(', ') || '-';
                
                // --- FIX STARTS HERE ---
                const now = new Date();
                const minutesSinceCreation = (now - createdAt) / 1000 / 60;
                const SESSION_TIMEOUT_MINUTES = 5; 

                let status, statusClass;

                const hasTimeSpent = visitor.time_spent_seconds !== null && typeof visitor.time_spent_seconds !== 'undefined';

                if (hasTimeSpent) {
                    status = visitor.time_spent_seconds > 30 ? 'Engaged' : 'Brief';
                    statusClass = 'status-idle';
                } else if (minutesSinceCreation < SESSION_TIMEOUT_MINUTES) {
                    status = 'Active';
                    statusClass = 'status-active';
                } else {
                    status = 'Ended';
                    statusClass = 'status-idle';
                }
                // --- FIX ENDS HERE ---

                return `
                    <tr>
                        <td>${createdAt.toLocaleString()}</td>
                        <td>${location}</td>
                        <td>${visitor.device_type || '-'}</td>
                        <td>${visitor.browser || '-'}</td>
                        <td title="${visitor.page_visited || ''}">${pageUrl}</td>
                        <td>${timeSpent}</td>
                        <td><code>${visitor.public_ip || '-'}</code></td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function updateFilters(meta) {
            updateFilterOptions('countryFilter', meta.distinct_countries);
            updateFilterOptions('deviceFilter', meta.distinct_devices);
            updateFilterOptions('browserFilter', meta.distinct_browsers);
        }

        function updateFilterOptions(filterId, options = []) {
            const select = document.getElementById(filterId);
            const currentValue = select.value;
            select.innerHTML = `<option value="">All ${filterId.replace('Filter', 's')}</option>`;
            options.forEach(option => {
                if (option) {
                    select.innerHTML += `<option value="${option}">${option}</option>`;
                }
            });
            select.value = currentValue;
        }

        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        }

        function showError(message) {
            const content = document.querySelector('.content');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            content.insertBefore(errorDiv, content.firstChild);
            setTimeout(() => errorDiv.remove(), 10000);
        }

        window.addEventListener('resize', () => mapRoot?.resize());
        window.addEventListener('beforeunload', () => mapRoot?.dispose());
    </script>
</body>
</html>

