<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <style>
        #chartdiv { width: 100%; height: 500px; }
        .loader { border-top-color: #4f46e5; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .visits-container { overflow: hidden; max-height: 1000px; transition: max-height 0.4s ease-in-out; }
        .visits-container.collapsed { max-height: 0; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">
    <div id="loader-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-80 z-50 flex justify-center items-center hidden"><div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div></div>
    
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold text-center text-gray-100 mb-8">Analytics Dashboard</h1>
        
        <div class="bg-gray-800 border border-gray-700 p-4 rounded-lg shadow-md mb-8 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-9 gap-4">
            <div class="md:col-span-1 lg:col-span-2"><label class="text-sm font-medium text-gray-400">Date Range</label><input id="date-filter" type="text" placeholder="All Time" class="w-full mt-1 p-2 border border-gray-600 rounded-md bg-gray-700"></div>
            <div class="md:col-span-1 lg:col-span-1"><label class="text-sm font-medium text-gray-400">Visitor Type</label><select id="visitor-type-filter" class="w-full mt-1 p-2 border border-gray-600 rounded-md bg-gray-700"></select></div>
            <div class="md:col-span-1 lg:col-span-1"><label class="text-sm font-medium text-gray-400">Country</label><select id="country-filter" class="w-full mt-1 p-2 border border-gray-600 rounded-md bg-gray-700"><option value="">All</option></select></div>
            <div class="md:col-span-1 lg:col-span-1"><label class="text-sm font-medium text-gray-400">Device</label><select id="device-filter" class="w-full mt-1 p-2 border border-gray-600 rounded-md bg-gray-700"><option value="">All</option></select></div>
            <div class="md:col-span-1 lg:col-span-1"><label class="text-sm font-medium text-gray-400">Browser</label><select id="browser-filter" class="w-full mt-1 p-2 border border-gray-600 rounded-md bg-gray-700"><option value="">All</option></select></div>
            <div class="col-span-2 md:col-span-2 lg:col-span-1"><label class="text-sm font-medium text-gray-400">URL</label><select id="url-filter" class="w-full mt-1 p-2 border border-gray-600 rounded-md bg-gray-700"><option value="">All</option></select></div>
            <div class="col-span-2 md:col-span-3 lg:col-span-2 grid grid-cols-3 gap-2">
                <div class="col-span-2"><label class="text-sm font-medium text-gray-400">IP Address</label><input id="ip-filter" list="ip-list" type="text" placeholder="Filter by IP..." class="w-full mt-1 p-2 border border-gray-600 rounded-md bg-gray-700"></div>
                <div class="flex items-end"><button id="reset-filters-btn" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-700">Reset</button></div>
            </div>
            <div class="col-span-2 lg:col-span-9 flex justify-end"><button id="apply-filters-btn" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700">Apply Filters</button></div>
            <datalist id="ip-list"></datalist>
        </div>
        
        <div id="stats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div class="lg:col-span-2 flex flex-col gap-8">
                <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg shadow-md"><h3 class="font-semibold mb-4 text-gray-100">Visitors by Country</h3><div id="chartdiv"></div></div>
                <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg shadow-md"><h3 class="font-semibold mb-4 text-gray-100">Visitors by Date</h3><canvas id="date-chart"></canvas></div>
            </div>
            <div class="flex flex-col gap-8">
                <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg shadow-md"><h3 class="font-semibold mb-4 text-gray-100">Visitors by Device</h3><canvas id="device-chart"></canvas></div>
                <div class="bg-gray-800 border border-gray-700 p-6 rounded-lg shadow-md"><h3 class="font-semibold mb-4 text-gray-100">Top Browsers</h3><canvas id="browser-chart"></canvas></div>
            </div>
        </div>

        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-md">
            <div class="p-4 border-b border-gray-700"><h3 class="text-lg font-semibold text-gray-100">Recent Visitors</h3></div>
            <div id="visitors-container" class="p-4 space-y-3"></div>
        </div>
    </div>

<script>
    let mapRoot, dateChart, deviceChart, browserChart, datePicker;
    const loader = document.getElementById('loader-overlay');

    function formatDuration(seconds) { /* ... function unchanged ... */ if (seconds === null || isNaN(seconds) || seconds < 0) return "N/A"; if (seconds < 60) return `${Math.round(seconds)}s`; const minutes = Math.floor(seconds / 60); const rem = Math.round(seconds % 60); return `${minutes}m ${rem}s`; }
    function renderStats(stats = {}) { /* ... function unchanged ... */ const totalVisitors = stats.total_visitors || 0; const uniqueVisitors = stats.unique_visitors || 0; const repeatedVisitors = (stats.total_visitors || 0) - (stats.unique_visitors || 0); const avgDuration = stats.avg_time_on_page || 0; document.getElementById("stats-grid").innerHTML = `<div class="bg-gray-800 p-6 rounded-lg border border-gray-700"><h3 class="text-sm font-medium text-gray-400">Total Visits</h3><p class="text-3xl font-bold mt-2">${totalVisitors}</p></div><div class="bg-gray-800 p-6 rounded-lg border border-gray-700"><h3 class="text-sm font-medium text-gray-400">Unique Visitors</h3><p class="text-3xl font-bold mt-2">${uniqueVisitors}</p></div><div class="bg-gray-800 p-6 rounded-lg border border-gray-700"><h3 class="text-sm font-medium text-gray-400">Repeated Visitors</h3><p class="text-3xl font-bold mt-2">${repeatedVisitors > 0 ? repeatedVisitors : 0}</p></div><div class="bg-gray-800 p-6 rounded-lg border border-gray-700"><h3 class="text-sm font-medium text-gray-400">Avg. Time on Page</h3><p class="text-3xl font-bold mt-2">${formatDuration(avgDuration)}</p></div>`;}
    
    // UPDATED: Now includes Country and City in the individual visit row
    function createSingleVisitHTML(visitor) {
        return `
        <div class="grid grid-cols-2 md:grid-cols-[1.5fr_1.5fr_2fr_1fr_2fr] gap-x-4 gap-y-2 items-center px-3 py-2 border-t border-gray-700/50 text-sm">
            <div class="col-span-2 md:col-span-1">
                <p class="text-gray-300 font-medium">${visitor.country || 'Unknown'}, ${visitor.city || 'N/A'}</p>
            </div>
            <div class="col-span-2 md:col-span-1">
                <p class="text-gray-300">${visitor.device_type || 'N/A'}</p>
                <p class="text-gray-400 text-xs">${visitor.browser || 'N/A'} on ${visitor.operating_system || 'N/A'}</p>
            </div>
            <div>
                <p class="text-gray-300 break-all" title="${visitor.page_visited || ''}">${visitor.page_visited || 'N/A'}</p>
            </div>
            <div class="text-left md:text-center">
                <span class="font-semibold text-gray-200">${formatDuration(visitor.time_spent_seconds)}</span>
            </div>
            <div class="text-left md:text-right">
                <p class="text-gray-300">${new Date(visitor.created_at).toLocaleString()}</p>
            </div>
        </div>`;
    }

    function createGroupHTML(ip, visits) { /* ... function unchanged ... */ const visitsHTML = visits.map(createSingleVisitHTML).join(''); const isCollapsed = visits.length > 1; return `<div class="bg-gray-800/50 rounded-lg border border-gray-700/50"><div class="group-header p-3 cursor-pointer flex justify-between items-center hover:bg-gray-700/50"><div><span class="font-mono text-indigo-400">${ip}</span><span class="ml-4 px-2 py-1 bg-gray-600 text-gray-200 text-xs rounded-full">${visits.length} ${visits.length > 1 ? 'visits' : 'visit'}</span></div><svg class="chevron-icon w-5 h-5 text-gray-400 transition-transform transform ${isCollapsed ? '-rotate-90' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></div><div class="visits-container ${isCollapsed ? 'collapsed' : ''}">${visitsHTML}</div></div>`; }
    function renderVisitors(visitors = []) { /* ... function unchanged ... */ const container = document.getElementById('visitors-container'); if (!visitors || visitors.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center py-8">No visitor data for this period.</p>'; return; } const groupedByIp = visitors.reduce((acc, visitor) => { const ip = visitor.public_ip || 'Unknown IP'; if (!acc[ip]) acc[ip] = []; acc[ip].push(visitor); return acc; }, {}); container.innerHTML = Object.entries(groupedByIp).map(([ip, visits]) => createGroupHTML(ip, visits)).join(''); }
    function renderMap(countryData = []) { /* ... function unchanged ... */ if (mapRoot) mapRoot.dispose(); mapRoot = am5.Root.new("chartdiv"); mapRoot.setThemes([am5themes_Animated.new(mapRoot)]); let chart = mapRoot.container.children.push(am5map.MapChart.new(mapRoot, { panX: "rotateX", projection: am5map.geoMercator() })); let polygonSeries = chart.series.push(am5map.MapPolygonSeries.new(mapRoot, { geoJSON: am5geodata_worldLow, exclude: ["AQ"], valueField: "value" })); polygonSeries.mapPolygons.template.setAll({ tooltipText: "{name}: {value}", interactive: true, fill: am5.color(0x4a5568) }); polygonSeries.mapPolygons.template.states.create("hover", { fill: am5.color(0x4f46e5) }); polygonSeries.set("heatRules", [{ target: polygonSeries.mapPolygons.template, key: "fill", min: am5.color(0x4a5568), max: am5.color(0x6366f1), dataField: "value" }]); polygonSeries.data.setAll(countryData); }
    function renderBreakdownCharts(deviceData = [], browserData = []) { /* ... function unchanged ... */ const chartOptions = { responsive: true, plugins: { legend: { position: "bottom", labels: { boxWidth: 12, color: '#a1a1aa' } } } }; if (deviceChart) deviceChart.destroy(); deviceChart = new Chart(document.getElementById("device-chart").getContext("2d"), { type: "pie", data: { labels: deviceData.map(d => d.device_type), datasets: [{ data: deviceData.map(d => d.count), backgroundColor: ["#4F46E5", "#7C3AED", "#EC4899"] }] }, options: chartOptions }); if (browserChart) browserChart.destroy(); browserChart = new Chart(document.getElementById("browser-chart").getContext("2d"), { type: "doughnut", data: { labels: browserData.map(d => d.browser), datasets: [{ data: browserData.map(d => d.count), backgroundColor: ["#10B981", "#F59E0B", "#3B82F6", "#D946EF", "#EF4444"] }] }, options: chartOptions }); }
    function renderDateChart(dateData = []) { /* ... function unchanged ... */ if (dateChart) dateChart.destroy(); dateChart = new Chart(document.getElementById("date-chart"), { type: "line", data: { labels: dateData.map(d => new Date(d.date).toLocaleDateString(undefined, { month: "short", day: "numeric" })), datasets: [{ label: "Sessions", data: dateData.map(d => d.count), borderColor: "#4F46E5", backgroundColor: "rgba(79,70,229,0.1)", fill: true, tension: .3 }] }, options: { responsive: true, scales: { y: { ticks: { color: "#a1a1aa" } }, x: { ticks: { color: "#a1a1aa" } } }, plugins: { legend: { display: false } } } }); }
    
    function populateSelectFilter(selectId, options, defaultLabel) { /* ... function unchanged ... */ const select = document.getElementById(selectId); if (select.options.length > 1 && selectId !== 'country-filter') return; select.innerHTML = `<option value="">${defaultLabel}</option>`; (options || []).sort().forEach(item => { const option = document.createElement("option"); option.value = item; option.textContent = item; select.appendChild(option); }); }
    function populateVisitorTypeFilter() { /* ... function unchanged ... */ const select = document.getElementById("visitor-type-filter"); select.innerHTML = `<option value="all">All Visitors</option><option value="unique">Unique</option><option value="repeated">Repeated</option>`; }
    
    // NEW: Function to populate the IP datalist for autocomplete
    function populateIpDatalist(ips = []) {
        const datalist = document.getElementById("ip-list");
        if (datalist.options.length > 0) return;
        (ips || []).forEach(ip => {
            const option = document.createElement("option");
            option.value = ip;
            datalist.appendChild(option);
        });
    }

    async function fetchAndRenderData() {
        loader.classList.remove('hidden');
        
        const params = new URLSearchParams({
            ...(document.getElementById("country-filter").value && { country_filter: document.getElementById("country-filter").value }),
            ...(datePicker.getStartDate() && { start_date_filter: datePicker.getStartDate().toISOString() }),
            ...(datePicker.getEndDate() && { end_date_filter: datePicker.getEndDate().toISOString() }),
            ...(document.getElementById("visitor-type-filter").value && { visitor_type_filter: document.getElementById("visitor-type-filter").value }),
            ...(document.getElementById("device-filter").value && { device_filter: document.getElementById("device-filter").value }),
            ...(document.getElementById("browser-filter").value && { browser_filter: document.getElementById("browser-filter").value }),
            ...(document.getElementById("url-filter").value && { url_filter: document.getElementById("url-filter").value }),
            ...(document.getElementById("ip-filter").value && { ip_filter: document.getElementById("ip-filter").value }) // Added IP filter
        });
        
        try {
            const response = await fetch(`/api/analytics?${params.toString()}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            data.stats.repeated_visitors = (data.stats.total_visitors || 0) - (data.stats.unique_visitors || 0);

            renderStats(data.stats);
            renderMap(data.charts.by_country);
            renderBreakdownCharts(data.charts.by_device, data.charts.by_browser);
            renderDateChart(data.charts.by_date);
            renderVisitors(data.visitor_list);

            populateSelectFilter("country-filter", data.meta.distinct_countries, "All Countries");
            populateSelectFilter("device-filter", data.meta.distinct_devices, "All Devices");
            populateSelectFilter("browser-filter", data.meta.distinct_browsers, "All Browsers");
            populateSelectFilter("url-filter", data.meta.distinct_urls, "All URLs");
            populateIpDatalist(data.meta.distinct_ips);

        } catch (error) {
            console.error("Failed to load analytics data:", error);
            document.body.innerHTML = `<div class="text-center p-8 text-red-400">Failed to load analytics data. Check the console and ensure the Flask server is running.</div>`;
        } finally {
            loader.classList.add('hidden');
        }
    }

    // NEW: Function to reset all filters
    function resetFilters() {
        document.querySelectorAll('select.w-full, input.w-full').forEach(el => el.value = '');
        populateVisitorTypeFilter(); // Repopulate static dropdown to default
        datePicker.clearSelection();
        fetchAndRenderData();
    }

    document.addEventListener('DOMContentLoaded', () => {
        datePicker = new Litepicker({ element: document.getElementById('date-filter'), singleMode: false, format: 'MMM D, YYYY' });
        document.getElementById('apply-filters-btn').addEventListener('click', fetchAndRenderData);
        document.getElementById('reset-filters-btn').addEventListener('click', resetFilters); // Added reset listener
        
        document.getElementById('visitors-container').addEventListener('click', (event) => {
            const header = event.target.closest('.group-header');
            if (header) {
                const container = header.nextElementSibling;
                container.classList.toggle('collapsed');
                const icon = header.querySelector('.chevron-icon');
                icon.classList.toggle('-rotate-90');
            }
        });
        
        populateVisitorTypeFilter();
        fetchAndRenderData();
    });
</script>
</body>
</html>
